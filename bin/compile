#!/bin/sh

# Parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

echo "-----> Installing cloudflared..."

mkdir -p $BUILD_DIR/vendor/cloudflared/bin
cp ./cloudflared $BUILD_DIR/vendor/cloudflared/bin/cloudflared
chmod +x $BUILD_DIR/vendor/cloudflared/bin/cloudflared

ln -s "../vendor/cloudflared/bin/cloudflared" $BUILD_DIR/bin/cloudflared

mkdir -p $BUILD_DIR/.profile.d
cp ./cloudflared.sh $BUILD_DIR/.profile.d/
chmod +x $BUILD_DIR/.profile.d/cloudflared.sh

echo "       Done"

if [ -z "$CLOUDFLARED_TUNNEL" ]; then
  if [ -z "$CLOUDFLARED_CREDENTIALS" ]; then
    echo "-----> Copying cloudflared configuration..."

    mkdir -p $BUILD_DIR/.cloudflared
    echo $CLOUDFLARED_CREDENTIALS > "$BUILD_DIR/.cloudflared/$CLOUDFLARED_TUNNEL.json"

    echo "cat $BUILD_DIR/.cloudflared/$CLOUDFLARED_TUNNEL.json"
    cat "$BUILD_DIR/.cloudflared/$CLOUDFLARED_TUNNEL.json"

    echo "       Done"
  fi
fi
